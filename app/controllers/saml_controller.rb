
# encoding: utf-8
class SamlController < ApplicationController
#   skip_before_action :authenticate_user!
#   skip_authorize_resource
#   skip_before_action :check_user_signed_in?


  def saml_signin
    connect_to =params[:idp]
    session[:connect_to] = connect_to
    $connect_to= connect_to
    $settings = saml_settings
    request = Onelogin::Saml::Authrequest.new($settings)

    action, content = request.create({},connect_to)
    render json: {saml_url: content, action: action}
  end

  def get_domain
    nordu_domains = [{"descr": "Identity Provider for Blekinge Institute of Technology", "title": "Blekinge Institute of Technology", "icon_height": "139", "geo": {"lat": "6.181775", "long": "15.590592"}, "auth": "saml", "icon_width": "114", "keywords": "BTH Blekinge+Tekniska+H\u00f6gskola Blekinge+Institute+of+Technology", "scope": "bth.se", "entityID": "https://idp2.bth.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp2.bth.se/idp/images/logo_bth.png"}, {"descr": "Identity Provider for Chalmers", "title": "Chalmers", "geo": {"lat": "7.6899722", "long": "11.9774444"}, "auth": "saml", "scope": "chalmers.se", "entityID": "http://idp.chalmers.se/adfs/services/trust", "type": "idp", "hidden": "false"}, {"descr": "Identity Provider for employees and students at Dalarna University.", "title": "Dalarna University", "icon_height": "16", "geo": {"lat": "0.6137", "long": "15.6536"}, "auth": "saml", "icon_width": "16", "keywords": "hda du", "scope": "du.se", "entityID": "https://login.du.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://login.du.se/duse-logo-16x16.png"}, {"descr": "Identity Provider for Ersta Sk\u00f6ndal University College", "title": "Ersta Sk\u00f6ndal University College", "auth": "saml", "scope": "esh.se", "entityID": "https://idp.esh.se/idp/shibboleth", "type": "idp", "hidden": "false"}, {"descr": "Identity Provider for Halmstad University", "title": "Halmstad University", "icon_height": "116", "geo": {"lat": "6.6647", "long": "12.8779"}, "auth": "saml", "icon_width": "350", "keywords": "hh hh.se hogskolan+i+halmstad halmstad+university", "scope": "hh.se", "entityID": "https://idp.hh.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.hh.se/idp/images/hh-logo-en-350x116.png"}, {"descr": "The J\u00f6nk\u00f6ping University Identity Provider is used by employees and students at the university.", "title": "J\u00f6nk\u00f6ping University", "icon_height": "140", "geo": {"lat": "7.7783", "long": "14.1633"}, "auth": "saml", "icon_width": "315", "keywords": "hj hogskolan+i+jonkoping jonkoping+university", "scope": "hj.se", "entityID": "https://idp.hj.se/idp/shibboleth", "psu": "http://hj.se/en/it-helpdesk/ju-faq---manuals/my-user-account/other/joint-web-login-service.html", "type": "idp", "hidden": "false", "icon": "https://idp.hj.se/idp/images/logo.png"}, {"descr": "Identity Provider for KTH", "title": "KTH Royal Institute of Technology", "icon_height": "225", "geo": {"lat": "9.34698", "long": "18.07213"}, "auth": "saml", "icon_width": "225", "keywords": "stockholm", "scope": "kth.se", "entityID": "https://saml.sys.kth.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://saml-5.sys.kth.se/idp/images/logo.png"}, {"descr": "Identity Provider for Karlstad University", "title": "Karlstad University", "icon_height": "280", "geo": {"lat": "9.4059", "long": "13.5816"}, "auth": "saml", "icon_width": "248", "keywords": "kau karlstads+universitet karlstad+universitet karlstad+university", "scope": "kau.se", "entityID": "https://weblogin.kau.se/idp/shibboleth", "psu": "http://www.kau.se/en/about-this-website", "type": "idp", "hidden": "false", "icon": "https://www.kau.se/themes/custom/kau16/images/logotype.png"}, {"descr": "Identity Provider for Karolinska Institutet.", "title": "Karolinska Institutet", "icon_height": "146", "geo": {"lat": "9.3475753", "long": "18.0279382"}, "auth": "saml", "icon_width": "292", "keywords": "ki karolinska+institutet", "scope": "ki.se", "entityID": "https://login.ki.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://login.ki.se/images/ki_logo_292x146.png"}, {"descr": "University of Arts, Crafts and Design", "title": "Konstfack", "icon_height": "75", "geo": {"lat": "9.2996777", "long": "17.9908419"}, "auth": "saml", "icon_width": "335", "scope": "konstfack.se,student.konstfack.se", "entityID": "https://idp-v2.konstfack.se/adfs/services/trust", "psu": "https://www.konstfack.se/en/About-Konstfack/About-this-site", "type": "idp", "hidden": "false", "icon": "https://idp-v2.konstfack.se/adfs/portal/logo/logo.png"}, {"descr": "The Kristianstad University Login Service is used by employees and students at the university.", "title": "Kristianstad University Sweden", "icon_height": "84", "geo": {"lat": "6.04848", "long": "14.14416"}, "auth": "saml", "icon_width": "96", "scope": "hkr.se", "entityID": "https://idp.hkr.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.hkr.se/idp/images/hkrsmall.png"}, {"descr": "Identity Provider for employees and students at Link\u00f6ping University.", "title": "Link\u00f6ping University", "icon_height": "68", "geo": {"lat": "8.397836", "long": "15.576008"}, "auth": "saml", "icon_width": "350", "scope": "liu.se", "entityID": "https://login.it.liu.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://login.it.liu.se/images/logo/logo-350x68-sv.png"}, {"descr": "Identity Provider for employees and students at Link\u00f6ping University.", "title": "Link\u00f6ping University (ADFS)", "icon_height": "126", "geo": {"lat": "8.397282", "long": "15.578624"}, "auth": "saml", "icon_width": "350", "keywords": "liu link\u00f6pings+universitet linkopings+universitet linkoping+university link\u00f6pings+university link\u00f6ping linkoping", "scope": "liu.se", "entityID": "http://fs.liu.se/adfs/services/trust", "psu": "https://liu.se/en/article/policy-for-hantering-av-personuppgifter-inom-ramen-for-identitetsutgivaren", "type": "idp", "hidden": "false", "icon": "https://liu.se/mall11/images/logo-350-en.png"}, {"descr": "The Linnaeus University Identity Provider is used by employees and students at the university.", "title": "Linnaeus University", "icon_height": "55", "geo": {"lat": "6.6661", "long": "16.3484"}, "auth": "saml", "icon_width": "361", "keywords": "lnu linn\u00e9 linn\u00e6us linne linnaeus linneuniversitetet linn\u00e9universitetet linnaeus+university", "scope": "lnu.se", "entityID": "https://idp.lnu.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.lnu.se/logo_swamid.png"}, {"descr": "The Linnaeus University Quality Assurance Identity Provider is used by employees and students at the university.", "title": "Linnaeus University QA", "icon_height": "55", "geo": {"lat": "6.6661", "long": "16.3484"}, "auth": "saml", "icon_width": "361", "keywords": "lnu linn\u00e9 linn\u00e6us linne linnaeus linneuniversitetet linnaeus+university", "scope": "lnu.se", "entityID": "https://idp.qa.lnu.se/idp/shibboleth", "type": "idp", "hidden": "true", "icon": "https://idp.qa.lnu.se/logo_swamid.png"}, {"descr": "Identity Provider for Lulea University of Technology", "title": "Lulea University of Technology", "auth": "saml", "keywords": "LTU lulea+tekniska+universitet lulea+university+of+technology", "scope": "ltu.se", "entityID": "https://idp.ltu.se/idp/shibboleth", "type": "idp", "hidden": "false"}, {"descr": "Identity Provider for employees and students at Lund University", "title": "Lund University", "icon_height": "76", "auth": "saml", "icon_width": "382", "keywords": "lu lth Lunds+universitet Lund+University", "scope": "lu.se", "entityID": "https://idpv3.lu.se/idp/shibboleth", "psu": "http://lucat.blogg.lu.se/anvandarvillkor-personuppgifter/acceptable-use-policy", "type": "idp", "hidden": "false", "icon": "https://idpv3.lu.se/idp/images/LU_eng_logo_382px.jpg"}, {"descr": "Identity Provider for Malm\u00f6 University", "title": "Malm\u00f6 University", "icon_height": "163", "geo": {"lat": "5.6087954", "long": "12.9945611"}, "auth": "saml", "icon_width": "56", "keywords": "mah mau malmo+universitet malmo+university", "scope": "mah.se", "entityID": "https://idp.mah.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://cdn.mah.se/images/header/en/mau-logo.svg"}, {"descr": "IDP at Mid Sweden University", "title": "Mid Sweden University", "icon_height": "111", "geo": {"lat": "3.176762", "long": "14.651352"}, "auth": "saml", "icon_width": "225", "keywords": "miun miu mittuniversitetet mid+sweden+university miunpunktse", "scope": "miun.se", "entityID": "https://miunidp.miun.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://www.miun.se/imagevault/publishedmedia/x4bl7padufcm1j4td3d7/logo.png"}, {"descr": "The M\u00e4lardalen University Identity Provider is used by employees and students at the university.", "title": "M\u00e4lardalen University", "icon_height": "117", "geo": {"lat": "9.6186", "long": "16.5407"}, "auth": "saml", "icon_width": "216", "keywords": "mdh vasteras eskilstuna malardalen malardalen+university malardalens+hogskola m\u00e4lardalens+h\u00f6gskola", "scope": "mdh.se", "entityID": "https://idp.mdh.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.mdh.se/idp/images/logo-sv.png"}, {"descr": "The NORDUnet A/S Identity Provider is used by employees and guests of NORDUnet.", "title": "NORDUnet", "icon_height": "46", "auth": "saml", "icon_width": "203", "scope": "nordu.net", "entityID": "https://idp.nordu.net/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://www.nordu.net/resources/NORDUnet2.jpg"}, {"descr": "Identity Provider for the National Library of Sweden.", "title": "National Library of Sweden", "icon_height": "516", "geo": {"lat": "9.33822", "long": "18.0722617"}, "auth": "saml", "icon_width": "488", "keywords": "Kungliga+biblioteket national+library+of+sweden", "scope": "kb.se", "entityID": "https://idp.kb.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.kb.se/idp/images/logga_FB.gif"}, {"descr": "Identity Provider for Royal College of Music in Stockholm", "title": "Royal College of Music in Stockholm", "icon_height": "141", "geo": {"lat": "9.34474", "long": "18.08126"}, "auth": "saml", "icon_width": "313", "keywords": "kmh kungliga+musikhogskolan royal+college+of+music stockholm kungl.+musikh\u00f6gskolan+i+stockholm", "scope": "kmh.se", "entityID": "https://idp.kmh.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.kmh.se/idp/images/logo.jpg"}, {"descr": "Identity Provider for the Royal Institute of Art (KKH)", "title": "Royal Institute of Art", "icon_height": "110", "geo": {"lat": "9.324458", "long": "18.082998"}, "auth": "saml", "icon_width": "404", "keywords": "KKH Kungl.+Konsth\u00f6gskolan Kungliga+Konsth\u00f6gskolan Royal+Institute+of+Art", "scope": "kkh.se", "entityID": "https://idp2.kkh.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp2.kkh.se/idp/images/kkh.png"}, {"descr": "Identity Provider for SICS", "title": "SICS", "icon_height": "95", "auth": "saml", "icon_width": "328", "scope": "sics.se", "entityID": "https://idp3.sics.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://www.sics.se/logo.png"}, {"descr": "Login using SITHS smartcards (via SUNET)", "title": "SITHS Login (SUNET)", "icon_height": "256", "auth": "saml", "icon_width": "256", "scope": "siths.sunet.se", "entityID": "https://siths-idp.sunet.se/saml2/idp/metadata.php", "type": "idp", "hidden": "false", "icon": "https://www.inera.se/Static/build/images/Inera-Logo.png"}, {"descr": "SMHI's IdP used by employees and guests of SMHI.", "title": "SMHI", "icon_height": "35", "geo": {"lat": "8.5811180", "long": "16.1450240"}, "auth": "saml", "icon_width": "100", "keywords": "SMHI", "scope": "smhi.se", "entityID": "https://weblogin.smhi.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://weblogin.smhi.se/idp/images/SMHIlogo.png"}, {"descr": "Login for SUNET employees", "title": "SUNET Employees", "icon_height": "205", "auth": "saml", "icon_width": "256", "scope": "sunet.se", "entityID": "https://idp.sunet.se/idp", "type": "idp", "hidden": "false", "icon": "https://static.sunet.se/images/sunet256.png"}, {"descr": "Identity Provider for Sophiahemmet University.", "title": "Sophiahemmet University", "icon_height": "122", "geo": {"lat": "9.34547", "long": "18.07525"}, "auth": "saml", "icon_width": "350", "keywords": "shh sophiahemmet+h\u00f6gskola sophiahemmet+university", "scope": "shh.se", "entityID": "https://swamid2.shh.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://swamid2.shh.se/idp/images/shh_logo.png"}, {"descr": "IdP for faculty, staff and students", "title": "Stockholm School of Economics IdP", "icon_height": "80", "geo": {"lat": "9.34161", "long": "18.05659"}, "auth": "saml", "icon_width": "80", "scope": "hhs.se", "entityID": "https://login.idp.hhs.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://login.idp.hhs.se/idp/images/logo.png"}, {"descr": "The Stockholm university Identity Provider is used by employees and students at the university.", "title": "Stockholm University", "icon_height": "110", "geo": {"lat": "9.3625", "long": "18.0586"}, "auth": "saml", "icon_width": "127", "scope": "su.se", "entityID": "https://idp.it.su.se/idp/shibboleth", "psu": "https://www.su.se/english/staff/it/it-services/policy-for-the-management-of-personal-information-within-the-scope-of-the-identity-provider-idp-1.384218", "type": "idp", "hidden": "false", "icon": "https://idp.it.su.se/idp/img/su-logo-en_OLD.gif"}, {"descr": "Identity Provider for uniarts.se.", "title": "Stockholm University of the Arts", "auth": "saml", "scope": "uniarts.se,student.uniarts.se", "entityID": "http://webproxysrv.uniarts.se/adfs/services/trust", "type": "idp", "hidden": "false"}, {"descr": "Identity Provider for Swedish Defence University", "title": "Swedish Defence University", "icon_height": "671", "auth": "saml", "icon_width": "2494", "keywords": "fhs", "scope": "fhs.se,student.fhs.se,op.fhs.se", "entityID": "http://login1.fhs.se/adfs/services/trust", "type": "idp", "hidden": "false", "icon": "https://login1.fhs.se/adfs/portal/logo/logo.jpg"}, {"descr": "Identity Provider for the Swedish Institute of Space Physics", "title": "Swedish Institute of Space Physics", "icon_height": "145", "geo": {"lat": "7.84", "long": "20.41"}, "auth": "saml", "icon_width": "144", "keywords": "irf kiruna rymdcampus rymdfysik", "scope": "irf.se", "entityID": "https://idpshibboleth.irf.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://www.irf.se/image/IRF_logo.png"}, {"descr": "Identity Provider for employees at Swedish Museum of Natural History", "title": "Swedish Museum of Natural History", "icon_height": "76", "auth": "saml", "icon_width": "88", "entityID": "http://adfs.nrm.se/adfs/services/trust", "type": "idp", "hidden": "false", "icon": "https://www.nrm.se/images/18.33f35f55112e1f929a580001275/1367709414980/Logga.gif"}, {"descr": "ADFS R\u00f6da Korsets H\u00f6gskola", "title": "Swedish Red Cross University College", "icon_height": "126", "auth": "saml", "icon_width": "200", "scope": "rkh.se", "entityID": "http://adfs.rkh.se/adfs/services/trust", "type": "idp", "hidden": "false", "icon": "https://dw.rkh.se/Logo.png"}, {"descr": "Identity Provider for Swedish University of Agricultural Science", "title": "Swedish University of Agricultural Scien..", "icon_height": "100", "auth": "saml", "icon_width": "100", "keywords": "slu sveriges+lantbruksuniversitet swedish+university+of+agricultural+sciences", "scope": "slu.se", "entityID": "https://idp2-1.slu.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp2-1.slu.se/info/images/slu_logotyp_web_100.png"}, {"descr": "Identity Provider for S\u00f6dert\u00f6rn University", "title": "S\u00f6dert\u00f6rn University", "icon_height": "118", "auth": "saml", "icon_width": "604", "scope": "suni.se", "entityID": "https://idp-v2.suni.se/adfs/services/trust", "type": "idp", "hidden": "false", "icon": "https://www.sh.se/p3/ext/res.nsf/vRes/global_1448973984543_sh_ny_logo_eng_png/$File/sh-ny-logo-eng.png"}, {"descr": "Identity Provider for the Royal Swedish Academy of Sciences", "title": "The Royal Swedish Academy of Sciences", "icon_height": "78", "geo": {"lat": "9.36542", "long": "18.05204"}, "auth": "saml", "icon_width": "179", "scope": "kva.se", "entityID": "https://idp.kva.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.kva.se/idp/images/headerLogo.gif"}, {"descr": "Identity Provider for the Swedish Council for Higher Education (UHR)", "title": "The Swedish Council for Higher Education", "icon_height": "80", "geo": {"lat": "9.33760", "long": "18.05835"}, "auth": "saml", "icon_width": "131", "keywords": "UHR Universitetes+och+H\u00f6gskoler\u00e5det VHS IPK The+Swedish+Council+for+Higher+Education", "scope": "uhr.se", "entityID": "https://shibboleth.uhr.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://shibboleth.uhr.se/idp/images/uhr_logo.png"}, {"descr": "IDP at Swedish Research Council", "title": "The Swedish Research Council", "icon_height": "148", "auth": "saml", "icon_width": "156", "keywords": "vr the+swedish+research+council vrpunktse", "scope": "vr.se", "entityID": "https://swamid.vr.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://www.vr.se/images/18.12fff4451215cbd83e4800013838/vetenskapsradet-logotyp.png"}, {"descr": "Identity Provider for The Swedish School of Sport and Health Sciences", "title": "The Swedish School of Sport and Health S..", "icon_height": "107", "geo": {"lat": "9.3467350", "long": "18.0811920"}, "auth": "saml", "icon_width": "204", "keywords": "gih gymnastik-+och+idrottsh\u00f6gskolan the+swedish+school+of+sport+and+health+sciences", "scope": "gih.se", "entityID": "https://idp01.gih.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp01.gih.se/idp/images/gihlogo.gif"}, {"descr": "Identity Provider for employees and students at Umea University.", "title": "Ume\u00e5 University", "icon_height": "63", "geo": {"lat": "3.820554", "long": "20.305799"}, "auth": "saml", "icon_width": "350", "keywords": "umu umea+universitet umea+universitet umea+university umea+university umea umea", "scope": "umu.se", "entityID": "http://adfs.umu.se/adfs/services/trust", "type": "idp", "hidden": "false", "icon": "https://www.umu.se/static/images/umu_logo_eng.jpg"}, {"descr": "Identity Provider for Ume\u00e5 University", "title": "Ume\u00e5 University - OLD", "icon_height": "63", "auth": "saml", "icon_width": "358", "keywords": "umu umea+universitet umea+university", "scope": "umu.se", "entityID": "https://idp.umu.se/saml2/idp/metadata.php", "type": "idp", "hidden": "true", "icon": "https://www.umu.se/static/images/umu_logo.jpg"}, {"descr": "Identity Provider for University College Stockholm", "title": "University College Stockholm", "icon_height": "100", "auth": "saml", "icon_width": "100", "scope": "ths.se,ehs.se", "entityID": "https://idp.ths.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.ths.se/idp/images/ehs_100x100.png"}, {"descr": "Identity Provider for University West", "title": "University West", "icon_height": "103", "geo": {"lat": "8.2822", "long": "12.2934"}, "auth": "saml", "icon_width": "200", "keywords": "hv h\u00f6gskolan+v\u00e4st university+west", "scope": "hv.se", "entityID": "https://idp.hv.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://logo.hv.se/logo-en.jpg"}, {"descr": "New Identity Provider for University West", "title": "University West new", "icon_height": "103", "geo": {"lat": "8.2822", "long": "12.2934"}, "auth": "saml", "icon_width": "200", "keywords": "hv h\u00f6gskolan+v\u00e4st university+west", "scope": "hv.se", "entityID": "http://adfs.hv.se/adfs/services/trust", "type": "idp", "hidden": "true", "icon": "https://logo.hv.se/logo-en.jpg"}, {"descr": "Identity Provider for employees and students at Bor\u00e5s University.", "title": "University of Bor\u00e5s", "icon_height": "90", "geo": {"lat": "7.724368", "long": "12.939918"}, "auth": "saml", "icon_width": "350", "keywords": "hb h\u00f6gskolan+i+bor\u00e5s hogskolan+i+boras textilhogskolan textilh\u00f6gskolan bibliotekshogskolan biblioteksh\u00f6gskolan university+of+bor\u00e5s textile+university+of+bor\u00e5s university+of+boras textile+university+of+boras boras+university+of+library+scieence bor\u00e5s+university+of+library+science", "scope": "hb.se", "entityID": "https://idp.hb.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://www.hb.se//PageFiles/41206/HBloggaSwamid.gif"}, {"descr": "The University of Gothenburg Identity Provider is used by employees and students at the university.", "title": "University of Gothenburg", "icon_height": "40", "geo": {"lat": "7.6981", "long": "11.9716"}, "auth": "saml", "icon_width": "277", "scope": "gu.se", "entityID": "https://idp3.it.gu.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://www.gu.se/digitalAssets/1374/1374690_lo_gu_left.png"}, {"descr": "https://www.gu.se/english/", "title": "University of Gothenburg (ADFS)", "auth": "saml", "entityID": "http://ADFS2.gu.se/adfs/services/trust", "type": "idp", "hidden": "true"}, {"descr": "The University of G\u00e4vle Identity Provider is used by employees and students at the university.", "title": "University of G\u00e4vle", "icon_height": "83", "geo": {"lat": "0.6692", "long": "17.1191"}, "auth": "saml", "icon_width": "94", "keywords": "g\u00e4vle gavle hig", "scope": "hig.se", "entityID": "https://idp3.hig.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://webkonto.student.hig.se/head/loggaengelska.png"}, {"descr": "Identity Provider for University of Sk\u00f6vde", "title": "University of Sk\u00f6vde", "icon_height": "196", "geo": {"lat": "8.39", "long": "13.85"}, "auth": "saml", "icon_width": "193", "keywords": "sk\u00f6vde his", "scope": "his.se", "entityID": "https://idp2.his.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://idp.his.se/his_eng_rubin.png"}, {"descr": "The Uppsala University Identity Provider is used by employees and students at the university.", "title": "Uppsala University", "icon_height": "50", "geo": {"lat": "9.857583", "long": "17.629500"}, "auth": "saml", "icon_width": "50", "keywords": "uppsala+university", "scope": "user.uu.se", "entityID": "https://weblogin.uu.se/idp/shibboleth", "psu": "https://weblogin.uu.se/english.html#2", "type": "idp", "hidden": "false", "icon": "https://weblogin.uu.se/idp/images/logga-50.png"}, {"descr": "eduID gives you a common login for your education", "title": "eduID", "icon_height": "120", "auth": "saml", "icon_width": "350", "keywords": "eduID+studentIdP", "scope": "eduid.se", "entityID": "https://login.idp.eduid.se/idp.xml", "psu": "https://www.eduid.se/privacy.html", "type": "idp", "hidden": "false", "icon": "https://eduid.se/static/img/ds-eduID-logo-black350x120px.png"}, {"descr": "The Identity Provider for students with account in the NyA-system.", "title": "www.universityadmissions.se", "auth": "saml", "keywords": "antagning.se universityadmissions.se", "scope": "antagning.se", "entityID": "https://idp.antagning.se/aws-idp", "type": "idp", "hidden": "false"}, {"descr": "\u00d6rebro University Identity Provider", "title": "\u00d6rebro University", "icon_height": "65", "geo": {"lat": "9.2547", "long": "15.2485"}, "auth": "saml", "icon_width": "90", "keywords": "ORU ORU.SE \u00d6rebro Orebro Orebro+universitet \u00d6rebro+University Orebro+university \u00d6rebro+universitet", "scope": "oru.se", "entityID": "https://shib-idp-2.oru.se/idp/shibboleth", "type": "idp", "hidden": "false", "icon": "https://shib-idp-2.oru.se/Logo_txt_runt_farg.gif"}]
    render json: {domains: nordu_domains}
  end

  def consume
    @response = Onelogin::Saml::Response.new(params[:SAMLResponse])
    @response.settings = $settings

    connect_to = $connect_to.to_s
    @response.decrypt(Rails.application.config.saml[:keys][:private])

    redirect_url = validate_and_sign_in_user(@response.attributes)
    redirect_to redirect_url
   
  end

  def metadata
    $settings = saml_settings
    meta = Onelogin::Saml::Metadata.new($settings,nil)
    render :xml => meta.generate
  end

  private

    def validate_and_sign_in_user(response_attributes)
      attributes_names = {
        "urn:oid:1.3.6.1.4.1.5923.1.1.1.6"  => "eduPersonPrincipalName",
        "urn:oid:0.9.2342.19200300.100.1.3" => "mail",
        "urn:oid:2.5.4.42" => "givenName",
        "urn:oid:2.5.4.4"  => "sn",
        "urn:oid:2.5.4.10" => "o",
        "urn:oid:1.3.6.1.4.1.5923.1.1.1.9"  => "eduPersonScopedAffiliation",
        "urn:oid:1.3.6.1.4.1.5923.1.1.1.10" => "eduPersonTargetedID"
      }

      attributes = {}
      if(!response_attributes.nil?)
        response_attributes.each do |k,v|
          if !attributes_names[k].nil?
            attributes[attributes_names[k]]= v[1]
          elsif !v[0].nil?
            attributes[v[0]]= v[1]
          end
        end
      end

      if( (attributes["mail"].nil? || attributes["mail"].empty?))
        if(!attributes["email"].nil? && !attributes["email"].empty?)
          attributes["mail"] = attributes["email"]
        elsif(!attributes["eduPersonPrincipalName"].nil? && !attributes["eduPersonPrincipalName"].empty?)
          attributes["mail"] = attributes["eduPersonPrincipalName"]
        end
      end

      # add university from email domain if missings
      if attributes["o"].nil? || attributes["o"].empty?
        attributes["o"] = attributes["mail"].split('@')[1].match(/(\w+\.\w+$)/)[1] rescue ""
      end

      email = attributes["mail"].downcase rescue ""
      saml_user = User.find_by_email(email)
      if saml_user.nil?
        # search for anonymised users
        user = User.get_anonymised_user(email)
        if !user.nil? 
          user = user.deanonymise(email)
          user.current_sign_in_at = Time.now
          token = user.create_new_auth_token
          return "#/users/login?#{token.to_query}"
        end
       return "#/users/signup?#{attributes.to_query}&saml=true"
      else
        if !saml_user.saml
          saml_user.name        = attributes["givenName"] || saml_user.name
          saml_user.last_name   = attributes["sn"]        || saml_user.last_name
          saml_user.university  = attributes["o"]         || saml_user.university
          saml_user.saml = true
          saml_user.skip_confirmation!
          saml_user.save
        end
        saml_user.current_sign_in_at = Time.now
        token = saml_user.create_new_auth_token
        return "#/users/login?#{token.to_query}"
      end
    end

    def saml_settings
      settings = Onelogin::Saml::Settings.new

      settings.assertion_consumer_service_url = "https://#{request.host}/saml/consume"
      settings.issuer                         = "https://#{request.host}"
      settings.idp_cert_fingerprint           = "12:60:D7:09:6A:D9:C1:43:AD:31:88:14:3C:A8:C4:B7:33:8A:4F:CB"
      settings.idp_metadata = "https://md.nordu.net/entities/#{CGI.escape($connect_to ||'')}"
      settings.display_name="Scalable Learning"
      settings.description={}
      settings.description["en"]="Blended learning platform for interactive in-class and online education."
      settings.description["sv"]="Plattform för stöd av \"flipped classroom\" utbildning."
      settings.information_url="https://#{request.host}/home/about"
      settings.privacy_url="https://#{request.host}/home/privacy"
      settings.logo="https://#{request.host}/assets/logo-a66e557f3f93b4d5195033ba1a1527a3.png"
      settings.sp_cert = Rails.application.config.saml[:keys][:public]
      settings.org_name="Scalable Learning"
      settings.org_display_name="Scalable Learning"
      settings.org_url ="#{request.host}"

      settings.contact = []
      settings.contact << { :type =>  "technical", :company => "ScalableLearning", :email => "support@scalable-learning.com" }
      settings.contact << { :type =>  "administrative", :company => "ScalableLearning", :email => "support@scalable-learning.com" }

      settings.requested_attributes =[]
      settings.requested_attributes << {:name => "1.3.6.1.4.1.5923.1.1.1.6", :required => true} #eduPersonPrincipalName
      settings.requested_attributes << {:name => "0.9.2342.19200300.100.1.3", :required => true} #mail
      settings.requested_attributes << {:name => "2.5.4.42", :required => true} #givenName
      settings.requested_attributes << {:name => "2.5.4.4", :required => true} #sn
      settings.requested_attributes << {:name => "2.5.4.10", :required => true} #o
      settings.requested_attributes << {:name => "1.3.6.1.4.1.5923.1.1.1.9", :required => true} #eduPersonScopedAffiliation

      settings.edugain=true

      settings
    end
end